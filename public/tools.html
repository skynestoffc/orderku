<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrderKuota Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
  </style>
</head>
<body class="gradient-bg min-h-screen text-gray-100">
  <div class="max-w-xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-2">OrderKuota Tools</h1>
    <p class="text-gray-400 mb-8">Get Token & QRIS Static</p>

    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700 mb-6">
      <h2 class="text-xl font-semibold mb-4">Step 1: Login</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Username</label>
          <input type="text" id="username" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white" placeholder="OK123456">
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Password</label>
          <input type="password" id="password" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white" placeholder="Your password">
        </div>
        <button onclick="requestOTP()" id="btnOtp" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg">
          Request OTP
        </button>
      </div>
    </div>

    <div id="otpSection" class="bg-slate-800/50 rounded-xl p-6 border border-slate-700 mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4">Step 2: Verify OTP</h2>
      <p class="text-gray-400 text-sm mb-4">OTP sent to: <span id="otpEmail" class="text-emerald-400"></span></p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">OTP Code</label>
          <input type="text" id="otp" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white" placeholder="123456">
        </div>
        <button onclick="verifyOTP()" id="btnVerify" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 rounded-lg">
          Verify & Get Token
        </button>
      </div>
    </div>

    <div id="resultSection" class="bg-slate-800/50 rounded-xl p-6 border border-slate-700 hidden">
      <h2 class="text-xl font-semibold mb-4">Your Credentials</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Username</label>
          <div class="flex gap-2">
            <input type="text" id="resultUsername" readonly class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-emerald-400">
            <button onclick="copy('resultUsername')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Copy</button>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Token</label>
          <div class="flex gap-2">
            <input type="text" id="resultToken" readonly class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-emerald-400 text-xs">
            <button onclick="copy('resultToken')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Copy</button>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">QRIS Static (Base QR String)</label>
          <div class="flex gap-2">
            <textarea id="resultQris" readonly class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-emerald-400 text-xs h-24"></textarea>
            <button onclick="copy('resultQris')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Copy</button>
          </div>
        </div>
        <div id="qrisImageContainer" class="text-center hidden">
          <label class="block text-sm text-gray-400 mb-2">Your QRIS</label>
          <img id="qrisImage" class="mx-auto rounded-lg" alt="QRIS">
        </div>
      </div>
    </div>

    <div id="errorMsg" class="bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg p-4 mt-4 hidden"></div>
    <div id="loadingMsg" class="text-center text-gray-400 mt-4 hidden">Loading...</div>
  </div>

  <script>
    const API = 'https://orderkuota-proxy.vercel.app';
    let savedUsername = '';

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    function setLoading(show) {
      document.getElementById('loadingMsg').classList.toggle('hidden', !show);
    }

    function copy(id) {
      const el = document.getElementById(id);
      navigator.clipboard.writeText(el.value);
      alert('Copied!');
    }

    async function requestOTP() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) return showError('Username and password required');

      setLoading(true);
      try {
        const res = await fetch(`${API}/api/auth/otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || 'Failed');

        const email = data.data?.results?.otp_value || 'your email';
        document.getElementById('otpEmail').textContent = email;
        document.getElementById('otpSection').classList.remove('hidden');
        savedUsername = username;
      } catch (e) {
        showError(e.message);
      }
      setLoading(false);
    }

    async function verifyOTP() {
      const otp = document.getElementById('otp').value.trim();
      if (!otp) return showError('OTP required');

      setLoading(true);
      try {
        const res = await fetch(`${API}/api/auth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: savedUsername, otp })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || 'Failed');

        const token = data.data?.results?.token;
        if (!token) throw new Error('Token not found');

        document.getElementById('resultUsername').value = savedUsername;
        document.getElementById('resultToken').value = token;

        // Get QRIS static from balance/menu endpoint
        const balRes = await fetch(`${API}/api/account/balance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: savedUsername, token })
        });
        const balData = await balRes.json();

        // Get QRIS URL and decode it
        const qrisUrl = data.data?.results?.qris || balData.data?.qris;
        if (qrisUrl) {
          await decodeQrisFromUrl(qrisUrl);
        }

        document.getElementById('resultSection').classList.remove('hidden');
      } catch (e) {
        showError(e.message);
      }
      setLoading(false);
    }

    async function decodeQrisFromUrl(url) {
      try {
        // Use a QR decoder service or show the URL
        document.getElementById('resultQris').value = 'QRIS URL: ' + url + '\n\nUse https://www.imagetotext.info/qr-code-scanner to decode the QR image and get the base string.';
        
        // Show QR image
        document.getElementById('qrisImage').src = url;
        document.getElementById('qrisImageContainer').classList.remove('hidden');
      } catch (e) {
        console.error(e);
      }
    }
  </script>
</body>
</html>
